c--------------------------------PAP------------------------------------cc     Calculates x-ray intensities using PAP model.c     program completed 10/89  by richard a. waldoc      subroutine papcwt(adelta,i,nel,nels,zx,ax,cnc,e0,xline,line,toa,     &mac,mode,za,a1,a2,b1,rc,rm,rx,symbol,caller,z)      implicit real*8 (d)      real zx(16),ax(16),cnc(16),mac(16,16),c1(16),flmdepth(6)     &,za(2),mparam,adelta(7),chiovl(6),p(3),ad(3),ju,javg,mavg      integer nel(7)      character*3 lintab(12)      character*7 symbol      character*26 callerb      character*1 mode,caller      data lintab/'Kb ','Ka ','Lg2','Lb3','Lb4','Lg1',     &           'Lb1','Lb2','La1','Mg ','Mb ','Ma '/cc          initialize variablesc      u0=e0/xline      rt=7.e-6*e0**1.65      sum=0.      tmpdepth=0.      do 2 j=1,6        tmpdepth=tmpdepth+adelta(j)        flmdepth(j)=tmpdepth2     continuecc Calculate starting compositions for the weighted-composition-iterationc using the same formula in my MAS'88 paper which was usedc for starting thicknesses.c      if (mode.eq.'F') then        do 5 j=1,nels          layer=layr(nel,j)          if (layer.eq.1) then            c1(j)=cnc(j)*(2.-adelta(1)/rt)*adelta(1)/rt          else if (layer.eq.7) then            c1(j)=cnc(j)*(1.-flmdepth(6)/rt)*(rt-flmdepth(6))/rt          else            c1(j)=cnc(j)*     &       (((2.-flmdepth(layer)/rt)*flmdepth(layer)/rt)-     &        ((2.-flmdepth(layer-1)/rt)*flmdepth(layer-1)/rt))c            c1(j)=cnc(j)*(2.-(adelta(layer-1)+adelta(layer))/rt)c     &     *(adelta(layer)-adelta(layer-1))/rt          endif          if (c1(j).le.0.) c1(j)=1.e-55       continue      else        do 6 j=1,nels6       c1(j)=cnc(j)      endif      iter=0      sum=0.      do 10 j=1,nels10      sum=sum+c1(j)      do 15 j=1,nels15      c1(j)=c1(j)/sum1      iter=iter+1      zn=0.      z=0.      mavg=0.      javg=0.      do 50 j=1,nels        mavg=mavg+zx(j)/ax(j)*c1(j)        zn=zn+alog(zx(j))*c1(j)        z=z+zx(j)*c1(j)        javg=javg+c1(j)*zx(j)/ax(j)*     &alog(zx(j)*(10.04+8.25*exp(-1.*zx(j)/11.22))/1000.)50    continue      zn=exp(zn)      javg=javg/mavg      javg=exp(javg)      p(1)=0.78      p(2)=0.1      p(3)=-1.*(0.5-0.25*javg)      ad(1)=6.6e-6      ad(2)=1.12e-5*(1.35-0.45*(javg*javg))      ad(3)=2.2e-6/javgc      dr0=0.      do 100 j=1,3        p1=1.+p(j)        p2=1.-p(j)        dr0=dr0+javg**p2*ad(j)/mavg*(e0**p1-xline**p1)/p1100   continue      q0=1.-.535*exp(-(21./zn)**1.2)-.00025*(zn/20.)**3.5      bet=40./z      operand=amin1((u0-1.)/bet,88.)      q=q0+(1.-q0)*exp(-operand)      adelt=z**.45      aad=1.+1./(u0**adelt)      drx=q*aad*dr0      rx=drx      if (mode.eq.'B') goto 200      if (abs(rx*1.e6-rt*1.e6).gt.0.02) then         call papwt(adelta,cnc,c1,nel,nels,-0.4*rx,rx)         rt=rx         goto 1      endif      call papwt(adelta,cnc,c1,nel,nels,-0.4*rx,0.5*rx)200   zp=0.      do 300 j=1,nels300     zp=zp+zx(j)**0.5*c1(j)      zp=zp*zp      eta=.00175*zp+0.37*(1.-exp(-1.*(.015*(zp**1.3))))      wavg=0.595+eta/3.7+eta**4.55      alph=(2.*wavg-1.)/(1.-wavg)      ju=1.+u0*(alog(u0)-1.)      gu=(u0-1.-((1.-(1./u0**(alph+1.)))/(1.+alph)))/     &((2.+alph)*ju)      rb=1.-eta*wavg*(1.-gu)      if (mode.eq.'F')     &call papwt(adelta,cnc,c1,nel,nels,-0.6*rx,0.7*rx)      z=0.      do 350 j=1,nels        z=z+zx(j)*c1(j)350   continue      return      end