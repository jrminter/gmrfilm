c-----------------------------WTFRACT---------------------------------cc     a subroutine to convert atomic formulac     to atomic percent and weight percentc     4/87 raw.c      subroutine wtfract(symb,formula,nl,cnc)      real wtpc(16),formula(16),cnc(16)            integer nl(3)      character*7 symb(16)c     Carpenter z not declared, added as real      real z(16)      c     This routine is where the problem is for bulk samplesc     calculating k ratio using atom proportion inputc     Gets into infinite loop calling lookup repeatedly c     Changed form to formulac     Confusing use of variable l looks like a onec     Carpenter debugc      write(*,20) symb,formula,nl,cncc20    format('Enter wtfrac: symb ', a7, ' formula ', f5.2,c    &' nl ', i3, ' cnc ', f6.2)          l=0      m=0c     For each layer 1 - 7      do 300 i=1,7        sumwp=0.        j=nl(i)        if (j.eq.0) goto 300        do 100 k=1,j          l=l+1c       Carpenter debugc       Problem: symb(l) is trashed and lookup not workingc       Problem: z is not set correctlyc         write(*,*) "Calling lookup from wtfract loop"          write(*,25) i,j,k,l,symb,z,a,ecr,lin25        format('WF1 i',i2,' j ',i2,' k ',i2,' l ',i2,     &' symb ',a7,' z ',f4.0,' a ',f8.2,' lin ',i4)                    call lookup(symb(l)(1:2),z,a,ecr,lin)          write(*,26) i,j,k,l,symb,z,a,ecr,lin26        format('WF2 i',i2,' j ',i2,' k ',i2,' l ',i2,     &' symb ',a7,' z ',f4.0,' a ',f8.2,' lin ',i4)           sumwp=sumwp+a*formula(l)          wtpc(l)=a*formula(l)100     continue        do 200 n=1,j          m=m+1          cnc(m)=wtpc(m)/sumwp200     continue300   continuec     Carpenter debugc      write(*,*) "Exiting wtfrac"             return      end